<div id="doc" class="markdown-body container-fluid comment-enabled" style="position: relative;"><h1 id="107-OS-homework-3-å¯¦ä½œKernel-Service">107 OS homework 3 å¯¦ä½œKernel Service</h1><blockquote>
<p>çµ„é•·ï¼šB10515050ã€æ—å…«æ—<br>
çµ„å“¡ï¼šB10515010ã€é™³æ˜€è«’<br>
çµ„å“¡ï¼šB10515048ã€æŸ¯åé´»<br>
github: <a href="https://github.com/tonyman1008/xv6-public" target="_blank" rel="noopener">https://github.com/tonyman1008/xv6-public</a></p>
</blockquote><hr><h1 id="ğŸ™‚-ä½¿ç”¨æƒ…å¢ƒèªªæ˜åŒ…å«æµç¨‹åœ–">ğŸ™‚ ä½¿ç”¨æƒ…å¢ƒèªªæ˜(åŒ…å«æµç¨‹åœ–)</h1><h2 id="æƒ…å¢ƒèªªæ˜">æƒ…å¢ƒèªªæ˜</h2><ul>
<li>
<h3 id="Copy-on-write">Copy-on-write</h3>
</li>
</ul><p>ä½¿ç”¨è€…åœ¨å­¸ç¿’copy-on-writeæ¦‚æ™‚ï¼Œè¨­è¨ˆä¸‰ç¨®ä¸åŒæ•™å­¸èª²ç¨‹ï¼Œåˆ©ç”¨ç¨‹å¼ç¢¼ä¾†è®“ä½¿ç”¨è€…èƒ½å……åˆ†ç†è§£ã€‚<br>
åœ¨ä¸åŒæƒ…å¢ƒä¸‹å‘¼å«system callæ™‚ï¼ŒgetNumFreePageå°‡å›å‚³ä¸åŒå€¼ã€‚<br>
ä¸‰ç¨®ç¨‹å¼ç¢¼åˆ†åˆ¥å±•ç¤ºäº†copy-on-writeåœ¨forkæ™‚ï¼Œå°å­è¡Œç¨‹åŠçˆ¶è¡Œç¨‹è®Šæ•¸å„æœ‰ä½•ç¨®æ”¹è®Šæ•ˆæœã€‚</p><ul>
<li>
<h3 id="æµç¨‹åœ–">æµç¨‹åœ–</h3>
</li>
</ul><p><img src="https://i.imgur.com/v9ySBNj.jpg" alt=""></p><hr><h1 id="ğŸ˜‡-Demoç•«é¢">ğŸ˜‡ Demoç•«é¢</h1><ul>
<li>
<h2 id="èµ·å§‹ç•«é¢">èµ·å§‹ç•«é¢</h2>
</li>
</ul><p><img src="https://i.imgur.com/eMOtjYT.png" alt=""></p><ul>
<li>
<h2 id="æ•™ç¨‹ä¸€0">æ•™ç¨‹ä¸€</h2>
</li>
</ul><p><img src="https://i.imgur.com/DQqokZn.png" alt=""></p><ul>
<li>
<h2 id="æ•™ç¨‹äºŒ0">æ•™ç¨‹äºŒ</h2>
</li>
</ul><p><img src="https://i.imgur.com/PL8CxzA.png" alt=""></p><ul>
<li>
<h2 id="æ•™ç¨‹ä¸‰0">æ•™ç¨‹ä¸‰</h2>
</li>
</ul><p><img src="https://i.imgur.com/dZsWeKG.png" alt=""></p><hr><h1 id="ğŸƒ-å¯¦ä½œéç¨‹ä¿®æ”¹å“ªäº›æª”æ¡ˆå«åœ–ç‰‡">ğŸƒ å¯¦ä½œéç¨‹(ä¿®æ”¹å“ªäº›æª”æ¡ˆ[å«åœ–ç‰‡])</h1><h2 id="ç¨‹å¼é‹ä½œæµç¨‹">ç¨‹å¼é‹ä½œæµç¨‹</h2><ul>
<li>åŠ å…¥è¨­è¨ˆåŸå› ã€ç¨‹å¼é‹ä½œæµç¨‹åŠå‘¼å«system callæœƒç”¢ç”Ÿçš„æ•ˆæœ</li>
<li>ä½¿ç”¨è€…å……åˆ†ç†è§£copy-on-writeåœ¨forkæ™‚å°æ–¼å­è¡Œç¨‹(child)åŠçˆ¶è¡Œç¨‹(parent)çš„å½±éŸ¿</li>
</ul><h2 id="æ•™ç¨‹ä¸€ï¼šforkå¾Œï¼Œå­è¡Œç¨‹ä¿®æ”¹è³‡æºå…§å®¹ï¼Œçˆ¶è¡Œç¨‹å…§å®¹ä¸è®Š">æ•™ç¨‹ä¸€ï¼šforkå¾Œï¼Œå­è¡Œç¨‹ä¿®æ”¹è³‡æºå…§å®¹ï¼Œçˆ¶è¡Œç¨‹å…§å®¹ä¸è®Š</h2><p><img src="https://i.imgur.com/LqgUxva.png" alt=""></p><h2 id="æ•™ç¨‹äºŒï¼šforkå¾Œï¼Œçˆ¶è¡Œç¨‹å†æ¬¡fork">æ•™ç¨‹äºŒï¼šforkå¾Œï¼Œçˆ¶è¡Œç¨‹å†æ¬¡fork</h2><p><img src="https://i.imgur.com/rsiOjvk.png" alt=""></p><h2 id="æ•™ç¨‹ä¸‰ï¼šè®“å­è¡Œç¨‹sleepï¼Œçˆ¶è¡Œç¨‹å„ªå…ˆåŸ·è¡Œ">æ•™ç¨‹ä¸‰ï¼šè®“å­è¡Œç¨‹sleepï¼Œçˆ¶è¡Œç¨‹å„ªå…ˆåŸ·è¡Œ</h2><p><img src="https://i.imgur.com/VkBhABJ.png" alt=""></p><h2 id="ä¿®æ”¹éçš„æª”æ¡ˆ1">ä¿®æ”¹éçš„æª”æ¡ˆ</h2><h3 id="Makefile">Makefile</h3><pre><code>UPROGS=\
...
_CopyOnWrite\
</code></pre><h3 id="CopyOnWritec">CopyOnWrite.c</h3><pre><code class="c hljs"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"types.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"stat.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"user.h"</span></span>

<span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">tutorial1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"åœ¨é‚„æ²’forkå‰free pageæ•¸é‡ï¼š%d\n"</span><span class="token punctuation">,</span> <span class="token function">getNumFreePages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Parent å’Œ Child å…±åŒä½¿ç”¨ä¸€å€‹å…¨åŸŸè®Šæ•¸ a \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"========åŸ·è¡Œç¬¬ä¸€æ¬¡fork========\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Child: a = %d\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"æ”¹è®Šå­è¡Œç¨‹aå‰free pageæ•¸é‡ï¼š%d\n"</span><span class="token punctuation">,</span> <span class="token function">getNumFreePages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Child: a = %d\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"ç¬¬ä¸€æ¬¡æ”¹è®Šå­è¡Œç¨‹aå¾Œfree pageæ•¸é‡ï¼š%d\n"</span><span class="token punctuation">,</span> <span class="token function">getNumFreePages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		a <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Child: a = %d\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"ç¬¬äºŒæ¬¡æ”¹è®Šå­è¡Œç¨‹aå¾Œfree pageæ•¸é‡ï¼š%d\n"</span><span class="token punctuation">,</span> <span class="token function">getNumFreePages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Parent: a = %d\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Parent: a = %d\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"åœ¨ç­‰å¾…å­è¡Œç¨‹çµæŸå¾Œfree pageæ•¸é‡ï¼š%d\n"</span><span class="token punctuation">,</span> <span class="token function">getNumFreePages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">tutorial2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"åœ¨é‚„æ²’forkå‰free pageæ•¸é‡ï¼š%d\n"</span><span class="token punctuation">,</span> <span class="token function">getNumFreePages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"========åŸ·è¡Œç¬¬ä¸€æ¬¡fork========\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"ç¬¬ä¸€å€‹å­è¡Œç¨‹"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"åœ¨ç¬¬äºŒæ¬¡forkå‰free pageæ•¸é‡ï¼š%d\n"</span><span class="token punctuation">,</span> <span class="token function">getNumFreePages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"========åŸ·è¡Œç¬¬äºŒæ¬¡fork========\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"ç¬¬äºŒå€‹å­è¡Œç¨‹"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"æ”¹è®Šç¬¬äºŒå€‹å­è¡Œç¨‹çš„aå‰free pageæ•¸é‡ï¼š%d\n"</span><span class="token punctuation">,</span> <span class="token function">getNumFreePages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			a <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Child: a = %d\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"æ”¹è®Šç¬¬äºŒå€‹å­è¡Œç¨‹çš„aå¾Œfree pageæ•¸é‡ï¼š%d\n"</span><span class="token punctuation">,</span> <span class="token function">getNumFreePages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"åœ¨ç¬¬ä¸€å€‹å­è¡Œç¨‹çµæŸå¾Œfree pageæ•¸é‡ï¼š%d\n"</span><span class="token punctuation">,</span> <span class="token function">getNumFreePages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"åœ¨ç¬¬äºŒå€‹å­è¡Œç¨‹çµæŸå¾Œfree pageæ•¸é‡ï¼š%d\n"</span><span class="token punctuation">,</span> <span class="token function">getNumFreePages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">tutorial3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"åœ¨é‚„æ²’forkå‰free pageæ•¸é‡ï¼š%d\n"</span><span class="token punctuation">,</span> <span class="token function">getNumFreePages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"========åŸ·è¡Œç¬¬ä¸€æ¬¡fork========\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"è®“å­è¡Œç¨‹sleep 4ç§’\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"ç¬¬ä¸€æ¬¡æ”¹è®Šå­è¡Œç¨‹aå‰free pageæ•¸é‡ï¼š%d\n"</span><span class="token punctuation">,</span> <span class="token function">getNumFreePages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		a <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Child: a = %d\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"ç¬¬ä¸€æ¬¡æ”¹è®Šå­è¡Œç¨‹aå¾Œfree pageæ•¸é‡ï¼š%d\n"</span><span class="token punctuation">,</span> <span class="token function">getNumFreePages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"åœ¨çˆ¶è¡Œç¨‹çµæŸå‰free pageæ•¸é‡ï¼š%d\n"</span><span class="token punctuation">,</span> <span class="token function">getNumFreePages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>

	<span class="token comment">//1</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"1.\n\
   int a = 1;          #å®£å‘Šä¸€å€‹å…¨åŸŸè®Šæ•¸a\n\
   if(fork()==0)       #è¤‡è£½ä¸€å€‹ä¸€å­è¡Œç¨‹,fork==0ä»£è¡¨å­è¡Œç¨‹,fork==1ä»£è¡¨çˆ¶è¡Œç¨‹,ä½¿free pageæ¸›å°‘\n\
   {  #æ­¤ç‚ºå­è¡Œç¨‹çš„å…§å®¹\n\
        a = 2;         #ç”±æ–¼è¦å¯«å…¥a,æ ¹æ“šcopy-on-writeçš„æ¦‚å¿µ,æ­¤æ™‚æœƒè¤‡è£½å‡ºä¸€ä»½a,ä½¿free pageæ¸›å°‘\n\
        a = 4;         #ç”±æ–¼å‰ä¸€è¡Œå·²è¤‡è£½å‡ºä¸€ä»½a,æ­¤æ™‚ä¿®æ”¹ä¸¦ä¸æœƒé¡å¤–è¤‡è£½,free pageä¸è®Š\n\
        exit();        #çµæŸå­è¡Œç¨‹\n\
   }\n\
    wait();            #ç­‰å¾…å­è¡Œç¨‹çµæŸ,è‹¥åœ¨æ­¤å¾Œè¼¸å‡ºa,açš„å€¼ä¸¦ä¸æœƒè¢«æ”¹è®Š\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//2</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"2.\n\
    int a = 1;         #å®£å‘Šä¸€å€‹å…¨åŸŸè®Šæ•¸a\n\
    if(fork()==0)      #è¤‡è£½ä¸€å€‹ä¸€å­è¡Œç¨‹,fork==0ä»£è¡¨å­è¡Œç¨‹,fork==1ä»£è¡¨çˆ¶è¡Œç¨‹,ä½¿free pageæ¸›å°‘\n\
    {  #æ­¤ç‚ºå­è¡Œç¨‹çš„å…§å®¹\n\
        exit();        #çµæŸç¬¬ä¸€å€‹å­è¡Œç¨‹,é‡‹å‡ºfree page\n\
    }\n\
    else  #åŸ·è¡Œç¬¬ä¸€å€‹çˆ¶è¡Œç¨‹\n\
    {  #æ­¤ç‚ºçˆ¶è¡Œç¨‹çš„å…§å®¹\n\
        if(fork()==0)  #è¤‡è£½ä¸€å€‹ä¸€å­è¡Œç¨‹,æ­¤æ™‚åŸä¾†çš„çˆ¶è¡Œç¨‹å°‡æœƒè¢«è¤‡è£½å‡ºç¬¬äºŒä»½,å› æ­¤æœƒå„ªå…ˆåŸ·è¡Œç¬¬ä¸€å€‹å­è¡Œç¨‹\n\
        {\n\
            a = 5;     #ç”±æ–¼è¦å¯«å…¥a,æ ¹æ“šcopy-on-writeçš„æ¦‚å¿µ,æ­¤æ™‚æœƒè¤‡è£½å‡ºä¸€ä»½a,ä½¿free pageæ¸›å°‘\n\
            exit();    #çµæŸç¬¬äºŒå€‹å­è¡Œç¨‹,é‡‹å‡ºfree page\n\
        }\n\
        wait();        #ç”±æ–¼ç¬¬ä¸€å€‹å­è¡Œç¨‹å·²ç¶“åŸ·è¡Œå®Œç•¢,æ­¤æ™‚çš„waitæ²’æœ‰ä»»ä½•ä½œç”¨\n\
    }\n\
    wait();            #ç­‰å¾…ç¬¬äºŒå€‹å­è¡Œç¨‹çµæŸ\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//3</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"3.\n\
    int a = 1;         #å®£å‘Šä¸€å€‹å…¨åŸŸè®Šæ•¸a\n\
    int pid = fork();  #è¤‡è£½ä¸€å€‹ä¸€å­è¡Œç¨‹,fork==0ä»£è¡¨å­è¡Œç¨‹,fork==1ä»£è¡¨çˆ¶è¡Œç¨‹\n\
    if(pid==0)\n\
    {  #æ­¤ç‚ºå­è¡Œç¨‹çš„å…§å®¹\n\
	sleep(4);      #sleep(4) è®“å­è¡Œç¨‹å…ˆåœæ­¢4ç§’å†åŸ·è¡Œ,å› æ­¤å…ˆåŸ·è¡Œçˆ¶è¡Œç¨‹\n\
        a = 5;         #ç”±æ–¼è¦å¯«å…¥a,æ ¹æ“šcopy-on-writeçš„æ¦‚å¿µ,æ­¤æ™‚æœƒè¤‡è£½å‡ºä¸€ä»½a,ä½¿free pageæ¸›å°‘\n\
        exit();        #çµæŸå­è¡Œç¨‹,é‡‹å‡ºfree page\n\
    }\n\
    wait();            #ç­‰å¾…å­è¡Œç¨‹çµæŸ\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"è«‹è¼¸å…¥æ•¸å­—1~3é¸æ“‡è©³ç´°ç¯„ä¾‹çš„æ•™ç¨‹,è¼¸å…¥4é›¢é–‹ç¨‹å¼.\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">char</span> <span class="token operator">*</span>inputC<span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		inputC <span class="token operator">=</span> <span class="token function">gets</span><span class="token punctuation">(</span><span class="token string">"9"</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> input <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>inputC<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>input <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"******************æ•™ç¨‹ä¸€******************\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">tutorial1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"\n****************æ•™ç¨‹çµæŸ******************\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>input <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"******************æ•™ç¨‹äºŒ******************\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">tutorial2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"\n****************æ•™ç¨‹çµæŸ******************\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>input <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"******************æ•™ç¨‹ä¸‰******************\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">tutorial3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"\n****************æ•™ç¨‹çµæŸ******************\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>input <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"é¸æ“‡æ•™ç¨‹,è«‹é‡æ–°è¼¸å…¥ï¼š\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><hr><h1 id="ğŸ˜-çµè«–">ğŸ˜ çµè«–</h1><p>Copy-on-writeåœ¨å…©å€‹processä½¿ç”¨åˆ°åŒä¸€è³‡æºæ™‚ï¼Œå¦‚æœåªæ˜¯åš"è®€å–"è³‡æ–™çš„å‹•ä½œï¼Œå°‡ä¸æœƒä½”ç”¨è¨˜æ†¶é«”ç©ºé–“ï¼Œå› è€Œfree pageæ•¸é‡ä¸¦ä¸æœƒæ¸›å°‘ã€‚ä¸€æ—¦ç•¶æŸä¸€processè©¦åœ–"å¯«å…¥"è³‡æ–™ï¼Œæ‰æœƒçœŸæ­£copyä¸€ä»½å°ˆç”¨å‰¯æœ¬çµ¦å®ƒã€‚</p><p>æ‰€ä»¥ï¼Œæˆ‘å€‘åˆ©ç”¨äº†system callä¾†é©—è­‰copy-on-writeæ¦‚å¿µï¼Œä¸¦è¨­è¨ˆäº†é€™å€‹ç¨‹å¼ä¾†è®“ä½¿ç”¨è€…èƒ½è¼•é¬†ç†è§£ã€‚ç¸½çµä¸€ä¸‹copy-on-writeçš„å„ªé»ï¼š</p><ul>
<li>åœ¨å°è³‡æ–™åªåš"è®€å–"æ“ä½œ(read-only)æ™‚ï¼Œä¸æœƒç”¢ç”Ÿå¤šé¤˜çš„å‰¯æœ¬ï¼Œèƒ½æ¸›å°‘å¯¦é«”è¨˜æ†¶é«”çš„ç©ºé–“ã€‚</li>
</ul><p>ä½†copy-on-writeä¹Ÿæ˜¯æœ‰ç¼ºé»å­˜åœ¨çš„ï¼Œæˆ‘å€‘èˆ‰ä¾‹å‡ºä»¥ä¸‹å¹¾é»ï¼š</p><ul>
<li>
<p>Page faultï¼š<br>
å¦‚æœåœ¨forkä¹‹å¾Œï¼Œçˆ¶è¡Œç¨‹åŠå­è¡Œç¨‹çš†æŒçºŒåŸ·è¡Œ"å¯«å…¥"æ“ä½œï¼Œé‚£éº¼å°‡æœƒç”¢ç”Ÿå¤§é‡çš„page faultã€‚</p>
</li>
<li>
<p>æ•¸æ“šä¸€è‡´å•é¡Œï¼š<br>
forkä¹‹å¾Œï¼Œå¦‚æœå­è¡Œç¨‹åŸ·è¡Œ"å¯«å…¥"æ“ä½œï¼ŒåŒæ™‚åˆå¸Œæœ›çˆ¶è¡Œç¨‹è®€å–åˆ°"ä¿®æ”¹å¾Œçš„å€¼"ï¼Œå°‡æœƒç™¼ç”ŸéŒ¯èª¤ï¼Œ    copy-on-writeåªèƒ½è®“è³‡æ–™æœ€çµ‚ä¸€è‡´ï¼Œä½†ä¸æ˜¯éš¨æ™‚éƒ½ä¸€è‡´ï¼Œå°è‡´ä½¿ç”¨ä¸Šçš„å›°é›£ã€‚</p>
</li>
</ul><hr><h1 id="ğŸ“…-çµ„å“¡åˆ†å·¥">ğŸ“… çµ„å“¡åˆ†å·¥</h1><p>çµ„é•·ï¼šB10515050ã€æ—å…«æ—ï¼šæŸ¥è©¢è³‡æ–™ã€è¨­è¨ˆä½¿ç”¨æƒ…å¢ƒ<br>
çµ„å“¡ï¼šB10515010ã€é™³æ˜€è«’ï¼šæŸ¥è©¢è³‡æ–™ã€è¨­è¨ˆä½¿ç”¨æƒ…å¢ƒ<br>
çµ„å“¡ï¼šB10515048ã€æŸ¯åé´»ï¼šæŸ¥è©¢è³‡æ–™ã€è¨­è¨ˆä½¿ç”¨æƒ…å¢ƒã€æ’°å¯«å ±å‘Š</p><hr><div dir="ltr" class="resize-sensor" style="position: absolute; left: -10px; top: -10px; right: 0px; bottom: 0px; overflow: hidden; z-index: -1; visibility: hidden;"><div class="resize-sensor-expand" style="position: absolute; left: -10px; top: -10px; right: 0; bottom: 0; overflow: hidden; z-index: -1; visibility: hidden;"><div style="position: absolute; left: 0px; top: 0px; transition: all 0s ease 0s; width: 100000px; height: 100000px;"></div></div><div class="resize-sensor-shrink" style="position: absolute; left: -10px; top: -10px; right: 0; bottom: 0; overflow: hidden; z-index: -1; visibility: hidden;"><div style="position: absolute; left: 0; top: 0; transition: 0s; width: 200%; height: 200%"></div></div></div></div>